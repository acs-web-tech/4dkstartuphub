# üì± StartupHub Android Shell ‚Äî Complete Build Guide (From Scratch)

> **Purpose:** This document is the single source of truth for building the native Android shell app.
> If you delete the project and start over, follow this guide exactly and you will NOT hit Gradle errors.
> Every version number here is battle-tested and confirmed working.

---

## üèóÔ∏è What This App Is

The Android app is a **React Native WebView shell** ‚Äî it is NOT a full native app.
It wraps the existing web app (`https://startup.4dk.in`) in a native container and adds:
- **Native Push Notifications** via Firebase Cloud Messaging (FCM)
- **Hardware Back Button** support
- **Deep Linking** (notification taps open the correct page)

---

## ‚úÖ Step 1: Prerequisites (Install These First)

| Tool | Required Version | Notes |
|------|-----------------|-------|
| **Node.js** | 18 or higher | Check: `node --version` |
| **Java JDK** | **17 or 21** | ‚ö†Ô∏è NOT Java 8 or 11. Check: `java -version` |
| **Android Studio** | Latest | Needed for SDK Manager |
| **Android SDK** | API Level 34 | Install via Android Studio ‚Üí SDK Manager |
| **Android NDK** | 25.1.8937393 | Install via Android Studio ‚Üí SDK Manager ‚Üí SDK Tools |

### Install Java 21 (Recommended)
Download from: https://adoptium.net/temurin/releases/?version=21

After install, verify:
```powershell
java -version
# Should show: openjdk version "21.x.x"
```

### Set JAVA_HOME (Windows)
```powershell
# Add to System Environment Variables:
JAVA_HOME = C:\Program Files\Eclipse Adoptium\jdk-21.x.x-hotspot
# Also add to PATH: %JAVA_HOME%\bin
```

---

## ‚úÖ Step 2: Create the React Native Project

```powershell
# Navigate to your project root (e.g., d:\STP)
cd d:\STP

# Create the shell project (use EXACT React Native version)
npx react-native@0.73.4 init StartupShell --version 0.73.4

cd StartupShell
```

> ‚ö†Ô∏è **Do NOT use the latest React Native** unless you re-verify all versions below.
> `0.73.4` is the confirmed working version.

---

## ‚úÖ Step 3: Install Dependencies

```powershell
# Inside d:\STP\StartupShell
npm install

# Install WebView
npm install react-native-webview@13.16.0

# Install Firebase (EXACT versions ‚Äî mismatches cause Manifest Merger errors)
npm install @react-native-firebase/app@23.8.6
npm install @react-native-firebase/messaging@23.8.6
```

---

## ‚úÖ Step 4: Configure Gradle (CRITICAL ‚Äî This Prevents All Gradle Errors)

### 4a. Root `android/build.gradle`
Replace the entire file with this exact content:

```groovy
buildscript {
    ext {
        buildToolsVersion = "34.0.0"
        minSdkVersion = 23          // ‚Üê MUST be 23+ for Firebase Messaging
        compileSdkVersion = 34
        targetSdkVersion = 34
        ndkVersion = "25.1.8937393"
        kotlinVersion = "1.8.0"
    }
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath("com.android.tools.build:gradle:8.2.1")   // ‚Üê AGP 8.2.1 (NOT 8.3+)
        classpath("com.facebook.react:react-native-gradle-plugin")
        classpath("org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion")
        classpath("com.google.gms:google-services:4.4.0")   // ‚Üê Google Services plugin
    }
}

apply plugin: "com.facebook.react.rootproject"
```

### 4b. Gradle Wrapper `android/gradle/wrapper/gradle-wrapper.properties`
Set the Gradle version to **8.6** (NOT 8.7+ which breaks with AGP 8.2.1):

```properties
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.6-all.zip
networkTimeout=10000
validateDistributionUrl=true
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
```

### 4c. App `android/app/build.gradle`
At the **very top**, add the plugins. At the **very bottom**, add Google Services:

```groovy
apply plugin: "com.android.application"
apply plugin: "org.jetbrains.kotlin.android"
apply plugin: "com.facebook.react"

// ... (rest of the file stays as generated by React Native init) ...

android {
    ndkVersion rootProject.ext.ndkVersion
    buildToolsVersion rootProject.ext.buildToolsVersion
    compileSdk rootProject.ext.compileSdkVersion

    namespace "io.startuphub.app"       // ‚Üê Your app's package name
    defaultConfig {
        applicationId "io.startuphub.app"
        minSdkVersion rootProject.ext.minSdkVersion
        targetSdkVersion rootProject.ext.targetSdkVersion
        versionCode 1
        versionName "1.0"
    }
    signingConfigs {
        debug {
            storeFile file('debug.keystore')
            storePassword 'android'
            keyAlias 'androiddebugkey'
            keyPassword 'android'
        }
    }
    buildTypes {
        debug {
            signingConfig signingConfigs.debug
        }
        release {
            signingConfig signingConfigs.debug   // Use debug key for now (production: generate your own)
            minifyEnabled false
            proguardFiles getDefaultProguardFile("proguard-android.txt"), "proguard-rules.pro"
        }
    }
}

dependencies {
    implementation("com.facebook.react:react-android")
    implementation("com.facebook.react:flipper-integration")

    if (hermesEnabled.toBoolean()) {
        implementation("com.facebook.react:hermes-android")
    } else {
        implementation 'org.webkit:android-jsc:+'
    }
}

apply from: file("../../node_modules/@react-native-community/cli-platform-android/native_modules.gradle"); applyNativeModulesAppBuildGradle(project)
apply plugin: 'com.google.gms.google-services'   // ‚Üê MUST be last line
```

---

## ‚úÖ Step 5: Set SDK Path

Create the file `android/local.properties` (this file is gitignored ‚Äî create it manually every time):

```properties
sdk.dir=C\:\\Users\\YourUsername\\AppData\\Local\\Android\\Sdk
```

> ‚ö†Ô∏è Use **double backslashes** on Windows. Replace `YourUsername` with your actual Windows username.
> To find your SDK path: Android Studio ‚Üí Settings ‚Üí Android SDK ‚Üí Android SDK Location.

---

## ‚úÖ Step 6: Firebase Setup

### 6a. Create Firebase Project
1. Go to https://console.firebase.google.com
2. Create a new project (or use existing)
3. Add an **Android app** with package name: `io.startuphub.app`
4. Download `google-services.json`
5. Place it at: `StartupShell/android/app/google-services.json`

### 6b. Enable Cloud Messaging
In Firebase Console ‚Üí Your Project ‚Üí Project Settings ‚Üí Cloud Messaging ‚Üí Enable Firebase Cloud Messaging API (V1).

### 6c. Server Service Account
1. Firebase Console ‚Üí Project Settings ‚Üí Service Accounts
2. Click "Generate new private key"
3. Save as `server/service-account.json`
4. This is used by the backend to send push notifications.

---

## ‚úÖ Step 7: Replace `App.tsx`

Replace the entire `StartupShell/App.tsx` with this production-ready code:

```tsx
import React, { useEffect, useRef, useState } from 'react';
import { BackHandler, Platform, Alert, StatusBar, SafeAreaView, PermissionsAndroid, Linking } from 'react-native';
import { WebView, WebViewMessageEvent } from 'react-native-webview';
import messaging from '@react-native-firebase/messaging';

const WEBSITE_URL = 'https://startup.4dk.in';  // ‚Üê Change this if your URL changes

const App = () => {
  const webViewRef = useRef<WebView>(null);
  const [canGoBack, setCanGoBack] = useState(false);
  const [webViewReady, setWebViewReady] = useState(false);
  const pendingToken = useRef<string | null>(null);
  const [startUrl, setStartUrl] = useState(WEBSITE_URL);

  // Deep Linking
  useEffect(() => {
    Linking.getInitialURL().then(url => {
      if (url && (url.startsWith('http') || url.startsWith('startup4dk://'))) {
        setStartUrl(url);
      }
    });
    const sub = Linking.addEventListener('url', (event) => {
      if (event.url) {
        webViewRef.current?.injectJavaScript(`window.location.href = '${event.url}'; true;`);
      }
    });
    return () => sub.remove();
  }, []);

  const sendTokenToWebView = (token: string) => {
    if (!webViewRef.current) { pendingToken.current = token; return; }
    const script = `
      (function() {
        var token = ${JSON.stringify(token)};
        if (typeof window.handleNativeToken === 'function') { window.handleNativeToken(token); }
        else { localStorage.setItem('fcm_native_token', token); }
        window.dispatchEvent(new CustomEvent('fcm_token', { detail: { token: token } }));
      })();
      true;
    `;
    webViewRef.current.injectJavaScript(script);
  };

  // Request Permission & Get FCM Token
  useEffect(() => {
    const init = async () => {
      try {
        if (Platform.OS === 'android' && Platform.Version >= 33) {
          await PermissionsAndroid.request(PermissionsAndroid.PERMISSIONS.POST_NOTIFICATIONS);
        }
        const authStatus = await messaging().requestPermission();
        const enabled = authStatus === messaging.AuthorizationStatus.AUTHORIZED ||
                        authStatus === messaging.AuthorizationStatus.PROVISIONAL;
        if (!enabled) return;
        const token = await messaging().getToken();
        pendingToken.current = token;
        if (webViewReady) sendTokenToWebView(token);
      } catch (error) { console.error('Notification setup failed:', error); }
    };
    init();
  }, []);

  useEffect(() => {
    if (webViewReady && pendingToken.current) {
      sendTokenToWebView(pendingToken.current);
      pendingToken.current = null;
    }
  }, [webViewReady]);

  useEffect(() => {
    return messaging().onTokenRefresh(token => {
      pendingToken.current = token;
      if (webViewReady) { sendTokenToWebView(token); pendingToken.current = null; }
    });
  }, [webViewReady]);

  // Notification Tap Handling
  useEffect(() => {
    messaging().getInitialNotification().then(msg => {
      if (msg?.data?.url) {
        const url = msg.data.url as string;
        setTimeout(() => {
          const full = url.startsWith('/') ? `${WEBSITE_URL}${url}` : url;
          webViewRef.current?.injectJavaScript(`window.location.href = ${JSON.stringify(full)}; true;`);
        }, 2000);
      }
    });
    return messaging().onNotificationOpenedApp(msg => {
      if (msg?.data?.url) {
        const url = msg.data.url as string;
        const full = url.startsWith('/') ? `${WEBSITE_URL}${url}` : url;
        webViewRef.current?.injectJavaScript(`window.location.href = ${JSON.stringify(full)}; true;`);
      }
    });
  }, []);

  // Foreground notifications ‚Äî handled by WebSocket in web app
  useEffect(() => { return messaging().onMessage(async () => {}); }, []);

  // Hardware Back Button
  useEffect(() => {
    const onBack = () => { if (canGoBack && webViewRef.current) { webViewRef.current.goBack(); return true; } return false; };
    BackHandler.addEventListener('hardwareBackPress', onBack);
    return () => BackHandler.removeEventListener('hardwareBackPress', onBack);
  }, [canGoBack]);

  const onMessage = (event: WebViewMessageEvent) => {
    try {
      const data = JSON.parse(event.nativeEvent.data);
      if (data.type === 'REQUEST_FCM_TOKEN') {
        messaging().getToken().then(token => sendTokenToWebView(token));
      }
    } catch {}
  };

  return (
    <SafeAreaView style={{ flex: 1, backgroundColor: '#000' }}>
      <StatusBar barStyle="light-content" backgroundColor="#000" />
      <WebView
        ref={webViewRef}
        source={{ uri: startUrl }}
        style={{ flex: 1 }}
        allowsBackForwardNavigationGestures
        onNavigationStateChange={(navState) => setCanGoBack(navState.canGoBack)}
        allowFileAccess={true}
        allowFileAccessFromFileURLs={true}
        allowUniversalAccessFromFileURLs={true}
        javaScriptEnabled={true}
        domStorageEnabled={true}
        sharedCookiesEnabled={true}
        thirdPartyCookiesEnabled={true}
        onMessage={onMessage}
        onLoadEnd={() => { setTimeout(() => setWebViewReady(true), 500); }}
      />
    </SafeAreaView>
  );
};

export default App;
```

---

## ‚úÖ Step 8: Build the APK

```powershell
cd d:\STP\StartupShell\android

# Clean first (always do this after config changes)
./gradlew clean

# Build Release APK
./gradlew assembleRelease
```

**Output APK location:**
```
d:\STP\StartupShell\android\app\build\outputs\apk\release\app-release.apk
```

Transfer this file to your phone and install it.

> ‚ö†Ô∏è **NEVER install `app-debug.apk` on a standalone phone.** It requires a Metro server connection and will show a red error screen.

---

## üî• Common Errors & Exact Fixes

### ‚ùå Error: "Unsupported class file major version 65" or "jlink" error
**Cause:** Java version mismatch. You're using Java 21 with an old Gradle/AGP.
**Fix:** Ensure Gradle = **8.6** and AGP = **8.2.1** (as set in Step 4).

---

### ‚ùå Error: "SDK location not found"
**Cause:** `local.properties` is missing or has wrong path.
**Fix:** Create `android/local.properties`:
```properties
sdk.dir=C\:\\Users\\YourUsername\\AppData\\Local\\Android\\Sdk
```

---

### ‚ùå Error: "Manifest merger failed" / Firebase version conflict
**Cause:** `minSdkVersion` is below 23, or Firebase versions are mismatched.
**Fix:**
- Set `minSdkVersion = 23` in `android/build.gradle` ext block.
- Use `@react-native-firebase/app@23.8.6` and `@react-native-firebase/messaging@23.8.6` (same version).

---

### ‚ùå Error: "Could not resolve com.android.tools.build:gradle:X.X.X"
**Cause:** AGP version not available or incompatible.
**Fix:** Use exactly `classpath("com.android.tools.build:gradle:8.2.1")`.

---

### ‚ùå Error: "Task :app:processReleaseGoogleServices FAILED" / google-services.json missing
**Cause:** `google-services.json` is not in `android/app/`.
**Fix:** Download from Firebase Console and place at `StartupShell/android/app/google-services.json`.

---

### ‚ùå Error: "Package name mismatch"
**Cause:** The `applicationId` in `build.gradle` doesn't match the package name in `google-services.json`.
**Fix:** Both must be `io.startuphub.app`. Check:
- `android/app/build.gradle` ‚Üí `applicationId "io.startuphub.app"`
- `google-services.json` ‚Üí `"package_name": "io.startuphub.app"`

---

### ‚ùå Error: "Unable to load script" (Red Screen on Phone)
**Cause:** You installed the **debug** APK, which needs a Metro server.
**Fix:** Build and install the **release** APK (`assembleRelease`).

---

### ‚ùå Push Notifications Not Working
**Check 1 ‚Äî Server logs:**
```
‚úÖ Firebase Admin initialized       ‚Üê Good
‚ö†Ô∏è Firebase Admin NOT initialized  ‚Üê Missing service-account.json
‚ö†Ô∏è No mobile devices registered    ‚Üê App hasn't sent token yet
```
**Check 2 ‚Äî App flow:**
1. User must be **logged in** on the website inside the WebView.
2. The FCM token is only sent to the server **after login** (AuthContext detects it).
3. Ensure `server/service-account.json` exists and is valid.

---

## üìã Quick Reference ‚Äî Confirmed Working Versions

| Component | Version |
|-----------|---------|
| React Native | 0.73.4 |
| React | 18.2.0 |
| @react-native-firebase/app | 23.8.6 |
| @react-native-firebase/messaging | 23.8.6 |
| react-native-webview | 13.16.0 |
| Android Gradle Plugin (AGP) | 8.2.1 |
| Gradle Wrapper | 8.6 |
| compileSdkVersion | 34 |
| minSdkVersion | 23 |
| targetSdkVersion | 34 |
| NDK | 25.1.8937393 |
| Kotlin | 1.8.0 |
| com.google.gms:google-services | 4.4.0 |
| Java JDK | 17 or 21 |

---

## üîÑ If You Need to Change the Website URL

1. Open `StartupShell/App.tsx`
2. Change line: `const WEBSITE_URL = 'https://startup.4dk.in';`
3. Rebuild: `./gradlew clean assembleRelease`

---

## üìÅ Key Files Reference

```
StartupShell/
‚îú‚îÄ‚îÄ App.tsx                          ‚Üê Main app code (WebView + FCM)
‚îú‚îÄ‚îÄ package.json                     ‚Üê Dependencies
‚îú‚îÄ‚îÄ android/
‚îÇ   ‚îú‚îÄ‚îÄ build.gradle                 ‚Üê Root Gradle config (AGP version here)
‚îÇ   ‚îú‚îÄ‚îÄ local.properties             ‚Üê SDK path (NOT in git ‚Äî create manually)
‚îÇ   ‚îú‚îÄ‚îÄ gradle/wrapper/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ gradle-wrapper.properties ‚Üê Gradle version (8.6)
‚îÇ   ‚îî‚îÄ‚îÄ app/
‚îÇ       ‚îú‚îÄ‚îÄ build.gradle             ‚Üê App config (package name, SDK versions)
‚îÇ       ‚îú‚îÄ‚îÄ google-services.json     ‚Üê Firebase config (NOT in git ‚Äî download from Firebase)
‚îÇ       ‚îî‚îÄ‚îÄ debug.keystore           ‚Üê Debug signing key (auto-generated)

server/
‚îî‚îÄ‚îÄ service-account.json             ‚Üê Firebase Admin SDK key (NOT in git ‚Äî download from Firebase)
```

> ‚ö†Ô∏è Files marked "NOT in git" must be re-created manually every time you clone the repo.
